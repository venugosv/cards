package ocv

import (
	"context"
	"encoding/json"

	"github.com/anzx/fabric-cards/pkg/integration/ocv"

	"github.com/anzx/fabric-cards/pkg/integration/ctm"
)

var partyRespOK = []byte(`[{"ocvId": "1000241689", "partyType": "P", "dateOfBirth": "1976-04-04", "status": "Active", "source": "CAP-CIS", "kycDetails": { "status": "CO","verificationLevel": "VM"    },    "gender": "F",    "sourceEstablishedDate": "2010-06-28",    "employeeIndicator": "N",    "employerName": "ANZ TDM PRIVATISED VALUE",    "occupation": {      "code": "253000"    },    "addresses": [      {        "addressUsageType": "Primary Mailing",        "addressLineOne": "8 WEYDALE ST",        "city": "DOUBLEVIEW",        "postalCode": "6018",        "state": "AU-WA",        "country": "AUS",        "region": "WA",        "deliveryId": "0",        "source": "CAP-CIS",        "startDate": "2016-12-04",        "endDate": "2999-12-31"      },      {        "addressUsageType": "Primary Residential",        "addressLineOne": "8 WEYDALE ST",        "city": "DOUBLEVIEW",        "postalCode": "6018",        "state": "AU-WA",        "country": "AUS",        "region": "WA",        "deliveryId": "0",        "source": "CAP-CIS",        "startDate": "2016-12-04",        "endDate": "2999-12-31"      }    ],    "phones": [      {        "phoneUsageType": "Mobile Telephone",        "phone": "+61699999999",        "preferred": "Y",        "source": "CAP-CIS",        "startDate": "2017-12-19",        "endDate": "2999-12-31"      }    ],    "emails": [      {        "emailUsageType": "Email",        "email": "MASKED@ANZ.TESTING.COM",        "source": "CAP-CIS",        "startDate": "1901-01-01"      }    ],    "identifiers": [      {        "identifierUsageType": "One Customer ID",        "identifier": "1000241689",        "startDate": "2021-03-20"      },      {        "identifierUsageType": "CAP ID",        "identifier": "4018443847",        "source": "CAP-CIS",        "startDate": "2021-03-20"      }    ],    "names": [      {        "nameUsageType": "Salutation",        "lastName": "MS DOBB",        "source": "CAP-CIS",        "startDate": "1901-01-01"      },      {        "nameUsageType": "Full Name",        "title": "MS",        "lastName": "WENDY DOBB",        "source": "CAP-CIS",        "startDate": "1901-01-01"      },      {        "nameUsageType": "Mailing Name",        "lastName": "MS W DOBB",        "source": "CAP-CIS",        "startDate": "1901-01-01"      }    ],    "preferences": [      {        "preferenceType": "Disclosure Indicator",        "preferenceValue": "N",        "preferenceReason": "Not Allowed",        "source": "CAP-CIS",        "startDate": "1901-01-01"      },      {        "preferenceType": "Advertising Indicator",        "preferenceValue": "Y",        "preferenceReason": "Allowed",        "source": "CAP-CIS",        "startDate": "1901-01-01"      }    ],    "sourceSystems": [      {        "sourceSystemName": "CAP-CIS",        "sourceSystemId": "4018443847"      }    ],    "accounts": [      {"accountNumber": "000000000000001234567890","accountType": "ACCOUNT","accountOpenedDate": "2016-09-16","accountBranchNumber": "4111","accountNameOne": "CarrollANZx Witting","accountStatus": "A","accountStatusRaw": "99","relationshipType": "SOL","productCode": "CAP-CIS:DDA","accountSubProduct": "CAP-CIS:DDAXD","companyId": "10","marketingCode": "TRANSACT01"},{        "accountNumber": "enc(6688390512341000)",        "accountOpenedDate": "2012-06-08",        "accountBranchNumber": "6484",        "accountNameOne": "WENDY DOBB",        "relationshipType": "SOL",        "productCode": "CAP-CIS:DDA",        "accountSubProduct": "CAP-CIS:DDASA",        "companyId": "10",        "addresses": [          {            "addressUsageType": "Statement",            "addressLineOne": "8 WEYDALE ST",            "city": "DOUBLEVIEW",            "postalCode": "6018",            "state": "AU-WA",            "country": "AUS",            "region": "WA",            "deliveryId": "0",            "startDate": "2021-03-24",            "endDate": "2999-12-31",            "occurrenceNumber": "0",            "atomicAttributes": [              {                "type": "ACCOUNT TITLE 1",                "value": "WENDY DOBB",                "startDate": "2018-12-28"              },              {                "type": "ELIGIBILITY FLAG",                "value": "N",                "startDate": "2021-03-24"              }            ]          }        ],        "atomicAttributes": [          {            "type": "NOMINATED MAILING INDICATOR",            "value": "Y",            "startDate": "2021-03-24"          },          {            "type": "NOMINATED ADDRESS USAGE TYPE",            "value": "Primary Residential",            "startDate": "2021-03-24"          }        ]      },      {        "accountNumber": "00000000000000202546052",        "accountOpenedDate": "2010-06-28",        "accountBranchNumber": "6281",        "accountNameOne": "ANCIA TAHENY",        "relationshipType": "SOL",        "productCode": "CAP-CIS:DDA",        "accountSubProduct": "CAP-CIS:DDAED",        "companyId": "10",        "addresses": [          {            "addressUsageType": "Statement",            "addressLineOne": "8 WEYDALE ST",            "city": "DOUBLEVIEW",            "postalCode": "6018",            "state": "AU-WA",            "country": "AUS",            "region": "WA",            "deliveryId": "0",            "startDate": "2021-03-24",            "endDate": "2999-12-31",            "occurrenceNumber": "0",            "atomicAttributes": [              {                "type": "ACCOUNT TITLE 1",                "value": "ANCIA TAHENY",                "startDate": "2018-12-28"              },              {                "type": "ELIGIBILITY FLAG",                "value": "N",                "startDate": "2021-03-24"              }            ]          }        ],        "atomicAttributes": [          {            "type": "NOMINATED MAILING INDICATOR",            "value": "Y",            "startDate": "2021-03-24"          },          {            "type": "NOMINATED ADDRESS USAGE TYPE",            "value": "Primary Residential",            "startDate": "2021-03-24"          }        ]      },      {        "accountNumber": "00000000000000186701752",        "accountOpenedDate": "2012-07-16",        "accountBranchNumber": "6281",        "accountNameOne": "ANCIA TAHENY",        "relationshipType": "TPS",        "productCode": "CAP-CIS:DDA",        "accountSubProduct": "CAP-CIS:DDASA",        "companyId": "10",        "addresses": [          {            "addressUsageType": "Statement",            "addressLineOne": "26 WRIGHT AV",            "city": "CLAREMONT",            "postalCode": "6010",            "state": "AU-WA",            "country": "AUS",            "region": "WA",            "deliveryId": "0",            "startDate": "2021-03-26",            "endDate": "2999-12-31",            "occurrenceNumber": "0",            "atomicAttributes": [              {                "type": "ACCOUNT TITLE 1",                "value": "ANCIA TAHENY",                "startDate": "2018-12-28"              },              {                "type": "ELIGIBILITY FLAG",                "value": "N",                "startDate": "2021-03-26"              }            ]          }        ],        "atomicAttributes": [          {            "type": "NOMINATED MAILING INDICATOR",            "value": "Y",            "startDate": "2021-03-26"          },          {            "type": "NOMINATED ADDRESS USAGE TYPE",            "value": "Primary Residential",            "startDate": "2021-03-26"          }        ]      },      {        "accountNumber": "00000000000000978269048",        "accountOpenedDate": "2018-01-10",        "accountBranchNumber": "6281",        "accountNameOne": "ANCIA TAHENY",        "relationshipType": "TPS",        "productCode": "CAP-CIS:CDA",        "accountSubProduct": "CAP-CIS:CDATE",        "companyId": "10",        "addresses": [          {            "addressUsageType": "Statement",            "addressLineOne": "26 WRIGHT AV",            "city": "CLAREMONT",            "postalCode": "6010",            "state": "AU-WA",            "country": "AUS",            "region": "WA",            "deliveryId": "0",            "startDate": "2021-03-24",            "endDate": "2999-12-31",            "occurrenceNumber": "0",            "atomicAttributes": [              {                "type": "ACCOUNT TITLE 1",                "value": "ANCIA TAHENY",                "startDate": "2018-12-28"              },              {                "type": "ELIGIBILITY FLAG",                "value": "N",                "startDate": "2021-03-24"              }            ]          }        ],        "atomicAttributes": [          {            "type": "NOMINATED MAILING INDICATOR",            "value": "Y",            "startDate": "2021-03-24"          },          {            "type": "NOMINATED ADDRESS USAGE TYPE",            "value": "Primary Residential",            "startDate": "2021-03-24"          }        ]      },      {        "accountNumber": "00000000000000000000016",        "accountOpenedDate": "2018-12-10",        "accountBranchNumber": "3026",        "accountNameOne": "DOBB",        "accountNameTwo": "WENDY",        "accountStatus": "Unknown",        "accountStatusRaw": "OP",        "relationshipType": "SOL",        "productCode": "CAP-CIS:SVC",        "accountSubProduct": "CAP-CIS:SVCASP",        "companyId": "10",        "addresses": [          {            "addressUsageType": "Statement",            "addressLineOne": "8 WEYDALE ST",            "city": "DOUBLEVIEW",            "postalCode": "6018",            "state": "AU-WA",            "country": "AUS",            "region": "WA",            "deliveryId": "0",            "startDate": "2021-03-24",            "endDate": "2999-12-31",            "occurrenceNumber": "0",            "atomicAttributes": [              {                "type": "ACCOUNT TITLE 1",                "value": "WENDY DOBB",                "startDate": "2018-12-28"              },              {                "type": "ELIGIBILITY FLAG",                "value": "N",                "startDate": "2021-03-24"              }            ]          }        ],        "atomicAttributes": [          {            "type": "NOMINATED MAILING INDICATOR",            "value": "Y",            "startDate": "2021-03-24"          },          {            "type": "NOMINATED ADDRESS USAGE TYPE",            "value": "Primary Residential",            "startDate": "2021-03-24"          }        ]      },      {        "accountNumber": "00000000000000202544882",        "accountOpenedDate": "2010-06-28",        "accountBranchNumber": "6281",        "accountNameOne": "ANCIA TAHENY",        "relationshipType": "SOL",        "productCode": "CAP-CIS:DDA",        "accountSubProduct": "CAP-CIS:DDAPT",        "companyId": "10",        "addresses": [          {            "addressUsageType": "Statement",            "addressLineOne": "8 WEYDALE ST",            "city": "DOUBLEVIEW",            "postalCode": "6018",            "state": "AU-WA",            "country": "AUS",            "region": "WA",            "deliveryId": "0",            "startDate": "2021-03-24",            "endDate": "2999-12-31",            "occurrenceNumber": "0",            "atomicAttributes": [              {                "type": "ACCOUNT TITLE 1",                "value": "ANCIA TAHENY",                "startDate": "2018-12-28"              },              {                "type": "ELIGIBILITY FLAG",                "value": "N",                "startDate": "2021-03-24"              }            ]          }        ],        "atomicAttributes": [          {            "type": "NOMINATED MAILING INDICATOR",            "value": "Y",            "startDate": "2021-03-24"          },          {            "type": "NOMINATED ADDRESS USAGE TYPE",            "value": "Primary Residential",            "startDate": "2021-03-24"          }        ]      },      {        "accountNumber": "00000000000000186701744",        "accountOpenedDate": "2012-07-16",        "accountBranchNumber": "6281",        "accountNameOne": "WENDY DOBB",        "relationshipType": "TPS",        "productCode": "CAP-CIS:DDA",        "accountSubProduct": "CAP-CIS:DDAPT",        "companyId": "10",        "addresses": [          {            "addressUsageType": "Statement",            "addressLineOne": "26 WRIGHT AV",            "city": "CLAREMONT",            "postalCode": "6010",            "state": "AU-WA",            "country": "AUS",            "region": "WA",            "deliveryId": "0",            "startDate": "2021-03-26",            "endDate": "2999-12-31",            "occurrenceNumber": "0",            "atomicAttributes": [              {                "type": "ACCOUNT TITLE 1",                "value": "WENDY DOBB",                "startDate": "2018-12-28"              },              {                "type": "ELIGIBILITY FLAG",                "value": "N",                "startDate": "2021-03-26"              }            ]          }        ],        "atomicAttributes": [          {            "type": "NOMINATED MAILING INDICATOR",            "value": "Y",            "startDate": "2021-03-26"          },          {            "type": "NOMINATED ADDRESS USAGE TYPE",            "value": "Primary Residential",            "startDate": "2021-03-26"          }        ]      }    ],    "links": [],    "historicDetails": {      "identifiers": []    }  }]`)

type StubClient struct {
	RetrievePartyErr      error
	RetrievePartyRespFunc []func([]*ocv.RetrievePartyRs)
	MaintainContractErr   error
}

func NewStubClient() StubClient {
	return StubClient{}
}

func (s StubClient) AccountMaintenance(_ context.Context, _ string, _ *ctm.DebitCardResponse, _ *ctm.DebitCardResponse, _ *ocv.RetrievePartyRsAccount) (bool, error) {
	return s.MaintainContractErr == nil, s.MaintainContractErr
}

func (s StubClient) RetrieveParty(_ context.Context, _ string) ([]*ocv.RetrievePartyRs, error) {
	if s.RetrievePartyErr != nil {
		return nil, s.RetrievePartyErr
	}
	var out []*ocv.RetrievePartyRs
	err := json.Unmarshal(partyRespOK, &out)

	for _, fn := range s.RetrievePartyRespFunc {
		fn(out)
	}

	return out, err
}
