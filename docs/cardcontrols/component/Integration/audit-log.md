# Audit Log

Library to publish audit logs easier. The library publishes the auditlog in JSON format to the configured GCP pubsub
topic. The JSON format that we send is structured according
to https://confluence.service.anz/display/FCR/Card+Events+from+Fabric. Fabric auditlog is a SDK that allows fabric
services to send data in a bank-wide specified format, which will be used by other bank teams to satisfy auditing
requirements and perform data analysis.

https://github.com/anzx/fabric-projects/wiki/Fabric-AuditLog-SDK has more information on how to integrate and test with
this library.

- **Contact**: fabric-projects

| env        | projectID                | topicID               |
|------------|------------              |------------           |
| ci         | auditlog(stubbed)        | auditlog(stubbed)     |
| intpnv     | anz-x-fabric-np-641432   | fabric-auditlog-pnv   |
| local      | auditlog(stubbed)        | auditlog(stubbed)     |
| pnv        | anz-x-fabric-np-641432   | fabric-auditlog-pnv   |
| preprod    | anz-x-cosmos-dev-7252fe  | cosmos-audit          |
| preprod-k  | anz-x-cosmos-sitk-911157 | cosmos-audit          |
| prod       | anz-x-cosmos-prod-ccc3bd | cosmos-audit          |
| sit        | anz-x-cosmos-dev-7252fe  | cosmos-audit          |
| sit-n      | anz-x-fabric-np-641432   | fabric-auditlog-sit-n |
| st         | anz-x-fabric-np-641432   | fabric-auditlog-st    |

#### AuditLog message Mapping

We send all fields as defined in https://confluence.service.anz/display/FCR/Card+Events+from+Fabric. These are
automatically added by the auditlog package and do not require fabric-cards intervention

|  Field        |             Sourced from                     |   Comments   |
| ------------- |---------------------------------------|------------- |
|Id             |pattern: `serviceDetails.provider-uuid`|              |
|auditTimestamp ||              |
|logTimestamp ||              |
|eventName ||              |
|eventFor ||              |
|ServiceDetails.Name| Name of the fabric-service|              |
|ServiceDetails.Provider| `fabric`|              |
|ServiceDetails.Type| `grpc`|              |
|ServiceDetails.Id| `pod.uid` in k8s env|              |
|ServiceDetails.Domain| `fabric.gcp.anz`|              |
|TrackingIds.TraceId |`trace-id` from http header: `traceparent` |  Added to context by opentelemetry            |
|TrackingIds.SpanId | Generated by opentelemetry.`StartSpan`|              |
|TrackingIds.SessionId | FRAM header `x-session-trace-auth`|              |
|Status.Code | grpc.statusCode |              |
|Status.Message | `SUCCESS` or `FAILURE` depending on status code above. |              |
|Status.details | |              |
|AuthenticationInfo.Type |const `"JWT"` |              |
|AuthenticationInfo.Method |from `anzxJWT.AMR` |              |
|AuthenticationInfo.Assurance |from `anzxJWT.ACR` |              |
|UserMetadata.Type | oneOf `"owner" | "rqf" | "actor"` |              |
|UserMetadata.Id[].Type | oneOf `"ocv"| "person"| "persona"| "staff/system""` |              |
|UserMetadata.Id[].Id | Corresponding value from `anzxJWT`  |              |
|UserDeviceMetadata.ClientIp|`x-sec-ip`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.Type|`x-sec-devicetype`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.Id|`x-sec-deviceid`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.OsType|`x-sec-ostype`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.OsVersion|`x-sec-osversion`|Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.Make|`x-sec-devicemake`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.Model|`x-sec-devicemodel`|Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.LocationLatitude|`x-sec-devicelatitude`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.LocationLongitude|`x-sec-devicelongitude`|Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.JailbrokenOrRooted|`x-sec-jailbroken`| Present only if grpc header added by ForgeRock |
|AnzChannelMetadata.Type|   | will be resolved by [#222](https://github.com/anzx/fabric-projects/issues/222).|
|AnzChannelMetadata.Name|  `x-anz-application-id` | |
|AnzChannelMetadata.Version|  | will be resolved by [#222](https://github.com/anzx/fabric-projects/issues/222).|
|AnzChannelMetadata.Id|  | will be resolved by [#222](https://github.com/anzx/fabric-projects/issues/222).|

## fabric/type/audit/servicedata/cards.proto

`ServiceData` are the custom fields we provide in an auditlog in addition to the attributes defined above. These change
from method to method.

### BlockCard

| Field | Type | Label | Description |
| ----- | ---- | ----- | ----------- |
| tokenized_card_number | string |  | Tokenized Card Number |
| last_4_digits | string |  | Last 4 digits of the Card Number |
| account_numbers | string | | Linked accounts

### UnblockCard

| Field | Type | Label | Description |
| ----- | ---- | ----- | ----------- |
| tokenized_card_number | string |  | Tokenized Card Number |
| last_4_digits | string |  | Last 4 digits of the Card Number |
| account_numbers | string | | Linked accounts

### RemoveVisaControl

| Field | Type | Label | Description |
| ----- | ---- | ----- | ----------- |
| tokenized_card_number | string |  | Tokenized Card Number |
| last_4_digits | string |  | Last 4 digits of the Card Number |
| control_type | string | repeated | The VISA Control type which is to be removed on the card, view the possible values [here](https://backstage.fabric.gcpnp.anz/docs/default/API/fabric.service.cardcontrols.v1beta2.CardControlsAPI/v1beta2/types/#controltype)|
| account_numbers | string | | Linked accounts

### SetVisaControl

| Field | Type | Label | Description |
| ----- | ---- | ----- | ----------- |
| tokenized_card_number | string |  | Tokenized Card Number |
| last_4_digits | string |  | Last 4 digits of the Card Number |
| control_type | string | repeated | The VISA Control type which is set on the card , view the possible values [here](https://backstage.fabric.gcpnp.anz/docs/default/API/fabric.service.cardcontrols.v1beta2.CardControlsAPI/v1beta2/types/#controltype)|
| account_numbers | string | | Linked accounts
