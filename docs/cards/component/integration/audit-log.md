# Audit Log

Library to publish audit logs easier. The library publishes the auditlog in JSON format to the configured GCP pubsub
topic. The JSON format that we send is structured according
to https://confluence.service.anz/display/FCR/Card+Events+from+Fabric. Fabric auditlog is a SDK that allows fabric
services to send data in a bank-wide specified format, which will be used by other bank teams to satisfy auditing
requirements and perform data analysis.

https://github.com/anzx/fabric-projects/wiki/Fabric-AuditLog-SDK has more information on how to integrate and test with
this library.

- **Contact**: #fabric-projects(pkg), #cosmos(data)

| env        | projectID                | topicID               |
|------------|------------              |------------           |
| ci         | auditlog(stubbed)        | auditlog(stubbed)     |
| intpnv     | anz-x-fabric-np-641432   | fabric-auditlog-pnv   |
| local      | auditlog(stubbed)        | auditlog(stubbed)     |
| pnv        | anz-x-fabric-np-641432   | fabric-auditlog-pnv   |
| preprod    | anz-x-cosmos-dev-7252fe  | cosmos-audit          |
| preprod-k  | anz-x-cosmos-sitk-911157 | cosmos-audit          |
| prod       | anz-x-cosmos-prod-ccc3bd | cosmos-audit          |
| sit        | anz-x-cosmos-dev-7252fe  | cosmos-audit          |
| sit-n      | anz-x-fabric-np-641432   | fabric-auditlog-sit-n |
| st         | anz-x-fabric-np-641432   | fabric-auditlog-st    |

#### AuditLog message Mapping

We send all fields as defined in https://confluence.service.anz/display/FCR/Card+Events+from+Fabric. These are
automatically added by the auditlog package and do not require fabric-cards intervention

|  Field        |             Sourced from                     |   Comments   |
| ------------- |---------------------------------------|------------- |
|Id             |pattern: `serviceDetails.provider-uuid`|              |
|auditTimestamp ||              |
|logTimestamp ||              |
|eventName ||              |
|eventFor ||              |
|ServiceDetails.Name| Name of the fabric-service|              |
|ServiceDetails.Provider| `fabric`|              |
|ServiceDetails.Type| `grpc`|              |
|ServiceDetails.Id| `pod.uid` in k8s env|              |
|ServiceDetails.Domain| `fabric.gcp.anz`|              |
|TrackingIds.TraceId |`trace-id` from http header: `traceparent` |  Added to context by opentelemetry            |
|TrackingIds.SpanId | Generated by opentelemetry.`StartSpan`|              |
|TrackingIds.SessionId | FRAM header `x-session-trace-auth`|              |
|Status.Code | grpc.statusCode |              |
|Status.Message | `SUCCESS` or `FAILURE` depending on status code above. |              |
|Status.details | |              |
|AuthenticationInfo.Type |const `"JWT"` |              |
|AuthenticationInfo.Method |from `anzxJWT.AMR` |              |
|AuthenticationInfo.Assurance |from `anzxJWT.ACR` |              |
|UserMetadata.Type | oneOf `"owner" | "rqf" | "actor"` |              |
|UserMetadata.Id[].Type | oneOf `"ocv"| "person"| "persona"| "staff/system""` |              |
|UserMetadata.Id[].Id | Corresponding value from `anzxJWT`  |              |
|UserDeviceMetadata.ClientIp|`x-sec-ip`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.Type|`x-sec-devicetype`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.Id|`x-sec-deviceid`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.OsType|`x-sec-ostype`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.OsVersion|`x-sec-osversion`|Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.Make|`x-sec-devicemake`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.Model|`x-sec-devicemodel`|Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.LocationLatitude|`x-sec-devicelatitude`| Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.LocationLongitude|`x-sec-devicelongitude`|Present only if grpc header added by ForgeRock |
|UserDeviceMetadata.JailbrokenOrRooted|`x-sec-jailbroken`| Present only if grpc header added by ForgeRock |
|AnzChannelMetadata.Type|   | will be resolved by [#222](https://github.com/anzx/fabric-projects/issues/222).|
|AnzChannelMetadata.Name|  `x-anz-application-id` | |
|AnzChannelMetadata.Version|  | will be resolved by [#222](https://github.com/anzx/fabric-projects/issues/222).|
|AnzChannelMetadata.Id|  | will be resolved by [#222](https://github.com/anzx/fabric-projects/issues/222).|

## fabric/type/audit/servicedata/cards.proto

`ServiceData` are the custom fields we provide in an auditlog in addition to the attributes defined above. These change
from method to method.

### ActivateCard

| Field | Type | Label | Description |
| ----- | ---- | ----- | ----------- |
| tokenized_card_number | string |  | Tokenized Card Number |
| last_4_digits | string |  | Last 4 digits of the Card Number |
| customer_class | string |  | Customer class assigned to the customer. Values present in the events from classic: ‘AGE’ – Agent Customer ‘ASE’ – Agent Small Business ‘BEE’ – Business Entity (IB4B BRN) ‘B4B’ – IB4B CRN ‘CNE’ – Consumer ‘SBE’ – Consumer Small Business ‘CCP’ – Companion CardFor ANZx, Only &#34;CNE&#34; is in scope for MLP. |
| issue_reason | string | | Card Issue reason. Possible Values: New, Reissue, Lost or Stolen
| account_numbers | string | | Linked accounts

### ChangePin

| Field | Type | Label | Description |
| ----- | ---- | ----- | ----------- |
| tokenized_card_number | string |  | Tokenized Card Number |
| last_4_digits | string |  | Last 4 digits of the Card Number |
| device_mobile_number | string |  | Mobile Number associated with the device |
| account_numbers | string | | Linked accounts

### ReplaceCard

| Field | Type | Label | Description |
| ----- | ---- | ----- | ----------- |
| tokenized_card_number | string |  | Tokenized Card Number |
| last_4_digits | string |  | Last 4 digits of the old Card Number |
| new_tokenized_card_number | string |  | New Tokenized Card Number |
| new_card_last_4_digits | string |  | Last 4 digits of the new Card Number |
| new_name_on_instrument | string |  | Embossed Name on the newly issued card |
| old_name_on_instrument | string |  | Embossed Name on old card |
| new_last_issue_date | string |  | Reissue date of new Card |
| old_last_issue_date | string |  | Reissue date of old Card |
| new_expiry_date | string |  | Expiry date of new card |
| old_expiry_date | string |  | Expiry date of old card |
| new_media_type | string |  | Media Type of new card C = Chip card D = Contactless-capable chip card M = Magnetic-stripe card N = Contactless-capable magnetic-stripe card P = Mobile Phone V = Virtual card (no physical instrument exists) W = Contactless only card Blank = Unknown/not provided. For ANZx, the value will be `N` |
| old_media_type | string | | Media Type of old card C = Chip card D = Contactless-capable chip card M = Magnetic-stripe card N = Contactless-capable magnetic-stripe card P = Mobile Phone V = Virtual card (no physical instrument exists) W = Contactless only card Blank = Unknown/not provided. For ANZx, the value will be `N` |
| old_issue_reason | string | | Card Issue reason of old Card Possible Values: New, Reissue, Lost or Stolen, Replacement |
| new_issue_reason | string | | Card Issue reason of new Card, Possible Values: Reissue, Lost or Stolen &amp; Replacement |
| account_numbers | string | | Linked accounts

### SetPin

| Field | Type | Label | Description |
| ----- | ---- | ----- | ----------- |
| tokenized_card_number | string |  | Tokenized Card Number |
| last_4_digits | string |  | Last 4 digits of the Card Number |
| device_mobile_number | string |  | Mobile Number associated with the device |
| account_numbers | string | | Linked accounts
